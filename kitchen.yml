# NOTE: This test-kitchen file contains ERB code to cut-down on boilerplate;
# YAML linters will complain!
# yamllint disable
<%
require 'open3'
require 'json'

# Parse the outputs of the test harness
tf_output, rc = Open3.capture2('terraform -chdir=test/setup output -json')
if rc != 0
  abort 'Failed to capture Terraform output from test/setup'
end
harness_outputs = JSON.parse(tf_output).map { |k,v| [k, v['value']] }.to_h

def tf_client(version)
  full_version, rc = Open3.capture2("asdf latest terraform #{version}")
  if rc != 0
    abort "Failed to determine latest terraform version matching #{version}"
  end
  client, rc = Open3.capture2("asdf where terraform #{full_version.chomp}")
  if rc != 0
    abort "Failed to locate installed terraform #{full_version.chomp} command"
  end
  "#{client.chomp}/bin/terraform"
end

def hash_to_input_var(params)
  "{#{params.map do |k, v|
        case v
        when nil
          "\\\"#{k}\\\"=null"
        when Hash
          "\\\"#{k}\\\"=#{hash_to_input_var(v)}"
        when Array
          "\\\"#{k}\\\"=[#{v.map do |e|
               case e
               when nil
                "null"
               when Hash
                 hash_to_input_var(e)
               when String
                 "\\\"#{e}\\\""
               else
                 "#{e}"
               end
             end.join(',')}]"
        when String
          "\\\"#{k}\\\"=\\\"#{v}\\\""
        else
          "\\\"#{k}\\\"=#{v}"
        end
      end.join(',')}}"
end

tf_clients = [0.14, 0.15, 1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6].map{ |v| ["tf#{v}".sub(/\W/, "-"), tf_client(v)]}.to_h
regional_replication = harness_outputs['replication'].reject{|k,_| k == 'global'}
%>
---
driver:
  name: terraform
  verify_version: true
  variables:
    project_id: <%= harness_outputs['project_id'] %>

transport:
  name: terraform
  command_timeout: 60

provisioner:
  name: terraform

verifier:
  name: terraform
  color: true
  systems:
    - name: secrets
      backend: gcp
      profile_locations:
        - test/profiles/secrets

platforms:
<% tf_clients.each do |k,v| %>
  - name: <%= k %>
    transport:
      client: <%= v %>
    driver:
      variables:
        prefix: <%= "#{harness_outputs['prefix']}-#{k}" %>
<% end %>

suites:
  - name: root-minimal
    transport:
      root_module_directory: test/fixtures/root
    driver:
      variables:
        test_name: root-minimal
        secret: terribleS3cr3t
  - name: root-all
    transport:
      root_module_directory: test/fixtures/root
    driver:
      variables:
        test_name: root-all
        accessors: '[\"serviceAccount:<%= harness_outputs['service_account_email'] %>\"]'
        annotations: '<%= hash_to_input_var(harness_outputs['annotations']) %>'
        labels: '<%= hash_to_input_var(harness_outputs['labels']) %>'
        auto_replication_kms_key_name: '<%= harness_outputs['replication']['global']['kms_key_name'] %>'
        replication: '<%= hash_to_input_var(regional_replication) %>'
        secret: terribleS3cr3t
  - name: root-null-secret
    transport:
      root_module_directory: test/fixtures/root
    driver:
      variables:
        test_name: root-null-secret
        # terraform-kitchen requires all values to be scalar, so use a flag in
        # the fixture to force setting value to null
        secret: 'null'
        null_secret: 'true'
  - name: root-empty-secret
    transport:
      root_module_directory: test/fixtures/root
    driver:
      variables:
        test_name: root-empty-secret
        secret: ''
  - name: root-replication-null-values
    transport:
      root_module_directory: test/fixtures/root
    driver:
      variables:
        test_name: root-replication-null-keys
        replication: '<%= hash_to_input_var(regional_replication.map{|k,_| [k, nil]}.to_h) %>'
        secret: terribleS3cr3t
  - name: root-replication-keys-null
    transport:
      root_module_directory: test/fixtures/root
    driver:
      variables:
        test_name: root-replication-keys-null
        replication: '<%= hash_to_input_var(regional_replication.map{|k,_| [k, {'kms_key_name' => nil}]}.to_h) %>'
        secret: terribleS3cr3t
  - name: root-replication-keys-empty
    transport:
      root_module_directory: test/fixtures/root
    driver:
      variables:
        test_name: root-replication-keys-empty
        replication: '<%= hash_to_input_var(regional_replication.map{|k,_| [k, {'kms_key_name' => ''}]}.to_h) %>'
        secret: terribleS3cr3t
  - name: example-accessors
    transport:
      root_module_directory: test/fixtures/examples/accessors
    driver:
      variables:
        test_name: example-accessors
        accessors: '[\"serviceAccount:<%= harness_outputs['service_account_email'] %>\"]'
        secret: terribleS3cr3t
  - name: example-all-options
    transport:
      root_module_directory: test/fixtures/examples/all-options
    driver:
      variables:
        test_name: example-all-options
        accessors: '[\"serviceAccount:<%= harness_outputs['service_account_email'] %>\"]'
        annotations: '<%= hash_to_input_var(harness_outputs['annotations']) %>'
        labels: '<%= hash_to_input_var(harness_outputs['labels']) %>'
        replication: '<%= hash_to_input_var(regional_replication) %>'
        secret: terribleS3cr3t
  - name: example-simple
    transport:
      root_module_directory: test/fixtures/examples/simple
    driver:
      variables:
        test_name: example-simple
        secret: terribleS3cr3t
  # Disabled - need to use -target to instantiate correctly
  # - name: example-with-random-provider
  #   transport:
  #     root_module_directory: test/fixtures/examples/with-random-provider
  #   driver:
  #     variables:
  #       test_name: example-with-random-provider
  - name: example-user-managed-replication
    transport:
      root_module_directory: test/fixtures/examples/user-managed-replication
    driver:
      variables:
        test_name: example-user-managed-replication
        secret: terribleS3cr3t
        replication: '<%= hash_to_input_var(regional_replication.map{|k,_| [k, nil]}.to_h) %>'
  - name: example-user-managed-replication-accessors
    transport:
      root_module_directory: test/fixtures/examples/user-managed-replication-accessors
    driver:
      variables:
        test_name: example-user-managed-replication-accessors
        accessors: '[\"serviceAccount:<%= harness_outputs['service_account_email'] %>\"]'
        secret: terribleS3cr3t
        replication: '<%= hash_to_input_var(regional_replication.map{|k,_| [k, nil]}.to_h) %>'
  - name: example-user-managed-replication-with-keys
    transport:
      root_module_directory: test/fixtures/examples/user-managed-replication-with-keys
    driver:
      variables:
        test_name: example-user-managed-replication-with-keys
        replication: '<%= hash_to_input_var(regional_replication) %>'
        secret: terribleS3cr3t
  - name: example-empty-secret-value
    transport:
      root_module_directory: test/fixtures/examples/empty-secret-value
    driver:
      variables:
        test_name: example-empty-secret-value
  - name: verify-issue-51
    excludes:
      - tf0-14
    transport:
      root_module_directory: test/fixtures/issue-51
    driver:
      variables:
        test_name: issue-51
        secret: terribleS3cr3t
  - name: example-auto-replication-with-key
    transport:
      root_module_directory: test/fixtures/examples/auto-replication-with-key
    driver:
      variables:
        test_name: example-auto-replication-with-key
        auto_replication_kms_key_name: '<%= harness_outputs['replication']['global']['kms_key_name'] %>'
        secret: terribleS3cr3t
